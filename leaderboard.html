<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title id="page-title">Leaderboard</title>
    <meta name="description" id="page-description" content="View the current leaderboard." />
    <link rel="stylesheet" href="assets/css/style.css" />
    <style>
      .hero-title-with-society { font-size: clamp(2rem, 2rem + 2vw, 4rem); }
      .hero-title-with-society h1 { font-size: 1em; margin: 0; }
      .hero-title-with-society .hero-society-name { font-size: 0.5em; display: block; margin-bottom: 0.35em; line-height: 1.2; opacity: 0.95; }
      body.society-invalid .top .logo,
      body.society-invalid .navbar__menu a,
      body.society-invalid .footer__nav a {
        pointer-events: none;
        opacity: 0.6;
        cursor: not-allowed;
      }
      .leaderboard-container {
        margin: 2em 0;
        overflow-x: auto;
      }
      .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0 auto;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .leaderboard-table thead {
        background: #169179;
        color: #fff;
      }
      .leaderboard-table th {
        padding: 1em 0.75em;
        text-align: left;
        font-weight: 600;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .leaderboard-table th:first-child { padding-left: 1.5em; }
      .leaderboard-table th:last-child { padding-right: 1.5em; }
      .leaderboard-table th.text-center { text-align: center; }
      .leaderboard-table th.text-right { text-align: right; }
      .leaderboard-table tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: background-color 0.2s;
      }
      .leaderboard-table tbody tr:hover {
        background-color: #f5f5f5;
      }
      .leaderboard-table tbody tr:last-child {
        border-bottom: none;
      }
      .leaderboard-table td {
        padding: 1em 0.75em;
        vertical-align: middle;
      }
      .leaderboard-table td:first-child { padding-left: 1.5em; }
      .leaderboard-table td:last-child { padding-right: 1.5em; }
      .leaderboard-table td.text-center { text-align: center; }
      .leaderboard-table td.text-right { text-align: right; }
      .leaderboard-position {
        font-weight: 700;
        color: #169179;
        font-size: 1.1em;
      }
      .leaderboard-player-name {
        font-weight: 600;
        color: #333;
      }
      .leaderboard-course {
        color: #666;
        font-size: 0.9em;
      }
      .leaderboard-date {
        color: #999;
        font-size: 0.85em;
      }
      .leaderboard-points {
        font-weight: 700;
        color: #169179;
        font-size: 1.1em;
      }
      .leaderboard-score {
        color: #333;
      }
      .leaderboard-section {
        color: #666;
        font-size: 0.9em;
      }
      .no-scores {
        text-align: center;
        padding: 3em 2em;
        color: #666;
      }
      .loading {
        text-align: center;
        padding: 3em 2em;
        color: #666;
      }
      .lb-section {
        margin-bottom: 3em;
      }
      .lb-section-title {
        font-size: 1.5em;
        font-weight: 700;
        color: #169179;
        margin-bottom: 0.75em;
        padding-bottom: 0.35em;
        border-bottom: 2px solid #169179;
      }
      .lb-subsection-title {
        font-size: 1.1em;
        font-weight: 600;
        color: #444;
        margin: 1.25em 0 0.5em 0;
      }
      .lb-overall-breakdown {
        color: #888;
        font-size: 0.9em;
        font-weight: normal;
      }
      .lb-overall-total {
        font-weight: 700;
        color: #169179;
        font-size: 1.1em;
      }
      .lb-per-outing-list {
        list-style: none;
        padding: 0;
        margin: 0.5em 0;
      }
      .lb-per-outing-list li {
        padding: 0.35em 0;
        border-bottom: 1px solid #eee;
      }
      .lb-per-outing-list li:last-child {
        border-bottom: none;
      }
      .lb-par3-detail {
        color: #888;
        font-size: 0.9em;
      }
      @media (max-width: 768px) {
        .leaderboard-table {
          font-size: 0.85em;
        }
        .leaderboard-table th,
        .leaderboard-table td {
          padding: 0.75em 0.5em;
        }
        .leaderboard-table th:first-child,
        .leaderboard-table td:first-child {
          padding-left: 1em;
        }
        .leaderboard-table th:last-child,
        .leaderboard-table td:last-child {
          padding-right: 1em;
        }
      }
    </style>
    <noscript>
      <style>
        img[loading] {
          opacity: 1;
        }
      </style>
    </noscript>
  </head>

  <body class="page-template has-hero-banner">
    <header class="top js-header">
      <a class="logo" href="index.html">
        <img src="assets/images/TGA.png" alt="TGA" width="80" height="40">
      </a>
      <nav class="navbar js-navbar">
        <button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false">
          <span class="navbar__toggle-box">
            <span class="navbar__toggle-inner">Menu</span>
          </span>
        </button>
        <ul class="navbar__menu">
          <li>
            <a href="index.html" target="_self">Home</a>
          </li>
          <li>
            <a href="outings.html" target="_self">Outings</a>
          </li>
          <li>
            <a href="scorecard.html" target="_self">Scorecard</a>
          </li>
          <li>
            <a href="scorecard-sidescroll.html" target="_self">Scorecard Side-Scroll</a>
          </li>
          <li>
            <a href="leaderboard.html" target="_self">Leaderboard</a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="page has-hero-banner">
      <article class="content">
        <div class="hero hero--banner">
          <figure class="hero__image">
            <div class="hero__image-wrapper">
              <img
                src="assets/images/golfBanner.jpg"
                loading="eager"
                alt="Golf course"
              />
            </div>
          </figure>
          <header class="hero__content hero__content--overlay">
            <div class="wrapper hero-title-with-society">
              <span id="hero-society-name" class="hero-society-name" style="display: none;"></span>
              <h1 id="hero-title">Leaderboard</h1>
            </div>
          </header>
        </div>
        <div id="society-error" class="entry-wrapper content__entry" style="display: none;">
          <section class="hero hero--image" style="padding: 2em; text-align: center;">
            <p id="society-error-message" style="color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; padding: 1.5em; border-radius: 8px; max-width: 480px; margin: 2em auto;">
              <strong>Society not found.</strong><br>
              Use a valid society ID in the URL (e.g. <code>leaderboard.html?societyId=your-society-id</code>).
            </p>
          </section>
        </div>
        <div id="main-content" class="entry-wrapper content__entry">
          <section class="hero hero--image">
            <div class="wrapper">
              <div id="leaderboard-container" class="leaderboard-container">
                <p class="loading">Loading leaderboard...</p>
              </div>
            </div>
          </section>
        </div>
      </article>
    </main>
    <footer class="footer">
      <div class="wrapper">
        <nav class="footer__nav">
          <ul>
            <li>
              <a href="outings.html" class="al" target="_self">Outings</a>
            </li>
            <li>
              <a href="scorecard.html" class="al" target="_self">Scorecard</a>
            </li>
            <li>
              <a href="leaderboard.html" class="al" target="_self">Leaderboard</a>
            </li>
          </ul>
        </nav>
        <div class="footer__copyright">
          <p>
            <span style="color: #169179;">by JP</span>
          </p>
        </div>
        <button id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top">
          <svg width="20" height="20" viewBox="0 0 24 24">
            <path d="M8 6L12 2L16 6" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M12 2V22" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
      </div>
    </footer>
    <script src="assets/js/config/app-config.js"></script>
    <script src="assets/js/utils/api-client.js"></script>
    <script>
      function escapeHtml(str) {
        if (str == null) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
          var date = new Date(dateStr);
          if (isNaN(date.getTime())) return dateStr;
          var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
          var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          return days[date.getDay()] + ' ' + months[date.getMonth()] + ' ' + date.getDate() + ' ' + date.getFullYear();
        } catch (e) {
          return dateStr;
        }
      }

      function formatNumber(num) {
        if (num == null || num === '') return '-';
        var n = parseFloat(num);
        return isNaN(n) ? '-' : n.toString();
      }

      /** Parse course parIndx string into array of par per hole (1–18). Returns array of 18 numbers or empty. */
      function parseParIndx(parIndx) {
        var s = (parIndx || '').toString().trim();
        if (!s) return [];
        var parts = s.split(',');
        var pars = [];
        if (parts.length >= 36) {
          if (parts.length >= 37) {
            for (var p = 1; p <= 18; p++) pars.push(parseInt(parts[p], 10) || 0);
          } else {
            for (var i = 0; i < 18; i++) pars.push(parseInt(parts[i], 10) || 0);
          }
        } else if (parts.length >= 18) {
          for (var j = 0; j < 18; j++) pars.push(parseInt(parts[j], 10) || 0);
        }
        return pars.length === 18 ? pars : [];
      }

      /** Get hole indices (0–17) that are par-3. */
      function getPar3Indices(pars) {
        var out = [];
        for (var i = 0; i < pars.length; i++) {
          if (pars[i] === 3) out.push(i);
        }
        return out;
      }

      /** Par-3 only: strokes 1=Ace, 2=Birdie, 3=Par, 4=Bogey, 5=Double, 6+=Triple+ */
      function par3StrokeToLabel(strokes) {
        var s = parseInt(strokes, 10);
        if (isNaN(s) || s < 1) return '-';
        if (s === 1) return 'Ace';
        if (s === 2) return 'Birdie';
        if (s === 3) return 'Par';
        if (s === 4) return 'Bogey';
        if (s === 5) return 'Double';
        return 'Triple+';
      }

      (async function() {
        await AppConfig.init();
        var sid = AppConfig.getSocietyId();
        var errorEl = document.getElementById('society-error');
        var errorMsg = document.getElementById('society-error-message');
        var mainEl = document.getElementById('main-content');
        var heroTitle = document.getElementById('hero-title');
        var container = document.getElementById('leaderboard-container');

        if (!sid) {
          document.body.classList.add('society-invalid');
          if (errorEl) errorEl.style.display = 'block';
          if (mainEl) mainEl.style.display = 'none';
          if (errorMsg) errorMsg.innerHTML = '<strong>No society selected.</strong><br>Add <code>?societyId=xxx</code> to the URL (e.g. <code>leaderboard.html?societyId=your-society-id</code>).';
          return;
        }
        if (!AppConfig.currentSociety) {
          document.body.classList.add('society-invalid');
          if (errorEl) errorEl.style.display = 'block';
          if (mainEl) mainEl.style.display = 'none';
          return;
        }

        document.body.classList.remove('society-invalid');
        if (errorEl) errorEl.style.display = 'none';
        if (mainEl) mainEl.style.display = 'block';
        var societyName = AppConfig.getSocietyName() || '';
        var heroSocietyEl = document.getElementById('hero-society-name');
        if (heroSocietyEl) {
          heroSocietyEl.textContent = societyName;
          heroSocietyEl.style.display = societyName ? 'block' : 'none';
        }
        if (heroTitle) heroTitle.textContent = 'Leaderboard';
        document.getElementById('page-title').textContent = (societyName ? societyName + ' - ' : '') + 'Leaderboard';

        try {
          var scoresRes = await ApiClient.get({ action: 'loadScores', limit: 500 });
          var outingsRes = await ApiClient.get({ action: 'getOutings' });
          var coursesRes = await ApiClient.get({ action: 'getCourses' });
          var scores = (scoresRes && scoresRes.scores) || [];
          var outings = (outingsRes && outingsRes.outings) || [];
          var courses = (coursesRes && coursesRes.courses) || [];

          var courseParMap = {};
          for (var c = 0; c < courses.length; c++) {
            var cn = (courses[c].courseName || '').trim().toLowerCase();
            if (!cn) continue;
            var pars = parseParIndx(courses[c].parIndx);
            courseParMap[cn] = { pars: pars, par3Indices: getPar3Indices(pars) };
          }

          if (scores.length === 0) {
            container.innerHTML = '<div class="no-scores"><p>No scores found.</p></div>';
            return;
          }

          var outingKey = function(course, date) {
            return (course || '').trim().toLowerCase() + '|' + (date || '').trim();
          };

          outings.sort(function(a, b) {
            var dA = new Date(a.date + (a.time ? 'T' + a.time : ''));
            var dB = new Date(b.date + (b.time ? 'T' + b.time : ''));
            return dA - dB;
          });

          var outingOrder = [];
          for (var o = 0; o < outings.length; o++) {
            outingOrder.push(outingKey(outings[o].courseName, outings[o].date));
          }

          var playerTotals = {};
          for (var s = 0; s < scores.length; s++) {
            var sc = scores[s];
            var name = (sc.playerName || '').trim();
            if (!name) continue;
            var key = outingKey(sc.course, sc.date);
            var pts = parseFloat(sc.totalPoints || 0) || 0;
            if (!playerTotals[name]) {
              playerTotals[name] = { totalPoints: 0, hcp: sc.handicap, pointsByOuting: {} };
            }
            playerTotals[name].totalPoints += pts;
            playerTotals[name].pointsByOuting[key] = pts;
            playerTotals[name].hcp = sc.handicap;
          }

          var overallList = [];
          for (var nameKey in playerTotals) {
            var rec = playerTotals[nameKey];
            var orderedPoints = [];
            for (var k = 0; k < outingOrder.length; k++) {
              if (rec.pointsByOuting[outingOrder[k]] != null) {
                orderedPoints.push(rec.pointsByOuting[outingOrder[k]]);
              }
            }
            overallList.push({
              name: nameKey,
              totalPoints: rec.totalPoints,
              hcp: rec.hcp,
              orderedPoints: orderedPoints
            });
          }
          overallList.sort(function(a, b) {
            return (b.totalPoints || 0) - (a.totalPoints || 0);
          });

          // Per-outing sections: one section per course (all scores for that CourseName = same outing, regardless of date)
          var courseOnlyKey = function(course) {
            return (course || '').trim().toLowerCase();
          };
          var scoresByOuting = {};
          for (var i = 0; i < scores.length; i++) {
            var key = courseOnlyKey(scores[i].course);
            if (!key) continue;
            if (!scoresByOuting[key]) scoresByOuting[key] = [];
            scoresByOuting[key].push(scores[i]);
          }

          var outingKeysSorted = [];
          for (var ok in scoresByOuting) outingKeysSorted.push(ok);
          outingKeysSorted.sort(function(a, b) {
            return a.localeCompare(b);
          });

          var html = '';

          html += '<div class="lb-section">';
          html += '<h2 class="lb-section-title">Overall Leaders</h2>';
          html += '<p class="lb-subsection-title">Total points over all outings</p>';
          html += '<table class="leaderboard-table">';
          html += '<thead><tr>';
          html += '<th>Pos</th><th>Name</th><th class="text-center">Hcp</th><th class="text-right">Total Points</th>';
          html += '</tr></thead><tbody>';
          for (var pos = 0; pos < overallList.length; pos++) {
            var pl = overallList[pos];
            var breakdown = pl.orderedPoints.length ? ('<span class="lb-overall-breakdown">[' + pl.orderedPoints.join('+') + '] </span>') : '';
            var totalSpan = '<span class="lb-overall-total">' + formatNumber(pl.totalPoints) + '</span>';
            html += '<tr>';
            html += '<td class="leaderboard-position">' + (pos + 1) + '</td>';
            html += '<td class="leaderboard-player-name">' + escapeHtml(pl.name) + '</td>';
            html += '<td class="text-center leaderboard-section">' + formatNumber(pl.hcp) + '</td>';
            html += '<td class="text-right">' + breakdown + totalSpan + '</td>';
            html += '</tr>';
          }
          html += '</tbody></table></div>';

          for (var oi = 0; oi < outingKeysSorted.length; oi++) {
            var oKey = outingKeysSorted[oi];
            var rawScores = scoresByOuting[oKey].slice();
            // One row per player (best score if same player has multiple entries for this course)
            var byPlayer = {};
            for (var ri = 0; ri < rawScores.length; ri++) {
              var rs = rawScores[ri];
              var pkey = (rs.playerName || '').trim().toLowerCase();
              if (!pkey) continue;
              var pts = parseFloat(rs.totalPoints) || 0;
              if (!byPlayer[pkey] || (parseFloat(byPlayer[pkey].totalPoints) || 0) < pts) byPlayer[pkey] = rs;
            }
            var outingScores = [];
            for (var pk in byPlayer) outingScores.push(byPlayer[pk]);
            outingScores.sort(function(a, b) {
              return (parseFloat(b.totalPoints) || 0) - (parseFloat(a.totalPoints) || 0);
            });
            var courseName = oKey;
            var courseNameDisplay = courseName;
            if (courses.length) {
              for (var x = 0; x < courses.length; x++) {
                if ((courses[x].courseName || '').trim().toLowerCase() === courseName) {
                  courseNameDisplay = (courses[x].courseName || courseName).trim();
                  break;
                }
              }
            }
            if (courseNameDisplay === courseName && outingScores[0] && (outingScores[0].course || '').trim()) {
              courseNameDisplay = outingScores[0].course.trim();
            }

            var bestOut = null, bestIn = null;
            for (var t = 0; t < outingScores.length; t++) {
              var so = outingScores[t];
              var op = parseFloat(so.outPoints) || 0, ip = parseFloat(so.inPoints) || 0;
              if (bestOut == null || op > (parseFloat(bestOut.outPoints) || 0)) bestOut = so;
              if (bestIn == null || ip > (parseFloat(bestIn.inPoints) || 0)) bestIn = so;
            }
            var courseData = courseParMap[courseName];
            var par3Indices = (courseData && courseData.par3Indices) ? courseData.par3Indices : [];
            var par3Candidates = [];
            if (par3Indices.length) {
              for (var q = 0; q < outingScores.length; q++) {
                var sq = outingScores[q];
                var holes = sq.holes || [];
                var par3Strokes = 0;
                var labels = [];
                for (var hi = 0; hi < par3Indices.length; hi++) {
                  var idx = par3Indices[hi];
                  var stroke = parseInt(holes[idx], 10);
                  if (!isNaN(stroke) && stroke > 0) par3Strokes += stroke;
                  labels.push(par3StrokeToLabel(holes[idx]));
                }
                par3Candidates.push({ score: sq, par3Strokes: par3Strokes, labels: labels });
              }
              par3Candidates.sort(function(a, b) {
                if (a.par3Strokes !== b.par3Strokes) return a.par3Strokes - b.par3Strokes;
                var hcpA = parseFloat(a.score.handicap) || 0, hcpB = parseFloat(b.score.handicap) || 0;
                return hcpB - hcpA;
              });
            }

            html += '<div class="lb-section">';
            html += '<h2 class="lb-section-title">' + escapeHtml(courseNameDisplay) + '</h2>';
            html += '<table class="leaderboard-table">';
            html += '<thead><tr>';
            html += '<th>Pos</th><th>Name</th><th class="text-center">Hcp</th><th class="text-right">Points</th>';
            html += '</tr></thead><tbody>';
            for (var r = 0; r < Math.min(3, outingScores.length); r++) {
              var ord = r === 0 ? '1st' : (r === 1 ? '2nd' : '3rd');
              html += '<tr>';
              html += '<td class="leaderboard-position">' + ord + '</td>';
              html += '<td class="leaderboard-player-name">' + escapeHtml(outingScores[r].playerName) + '</td>';
              html += '<td class="text-center leaderboard-section">' + formatNumber(outingScores[r].handicap) + '</td>';
              html += '<td class="text-right leaderboard-points">' + formatNumber(outingScores[r].totalPoints) + '</td>';
              html += '</tr>';
            }
            if (bestOut) {
              html += '<tr>';
              html += '<td class="leaderboard-position">F9</td>';
              html += '<td class="leaderboard-player-name">' + escapeHtml(bestOut.playerName) + '</td>';
              html += '<td class="text-center leaderboard-section">' + formatNumber(bestOut.handicap) + '</td>';
              html += '<td class="text-right leaderboard-points">' + formatNumber(bestOut.outPoints) + '</td>';
              html += '</tr>';
            }
            if (bestIn) {
              html += '<tr>';
              html += '<td class="leaderboard-position">B9</td>';
              html += '<td class="leaderboard-player-name">' + escapeHtml(bestIn.playerName) + '</td>';
              html += '<td class="text-center leaderboard-section">' + formatNumber(bestIn.handicap) + '</td>';
              html += '<td class="text-right leaderboard-points">' + formatNumber(bestIn.inPoints) + '</td>';
              html += '</tr>';
            }
            if (par3Candidates.length > 0) {
              var best = par3Candidates[0];
              var bestStrokes = best.par3Strokes;
              var bestHcp = parseFloat(best.score.handicap) || 0;
              var tied = par3Candidates.filter(function(c) {
                return c.par3Strokes === bestStrokes && (parseFloat(c.score.handicap) || 0) === bestHcp;
              });
              var posLabel = tied.length > 1 ? 'P3*' : 'P3';
              for (var ti = 0; ti < tied.length; ti++) {
                var tc = tied[ti];
                var labelStr = tc.labels.length ? ('<span class="lb-overall-breakdown">[' + tc.labels.join(', ') + '] </span>') : '';
                html += '<tr>';
                html += '<td class="leaderboard-position">' + posLabel + '</td>';
                html += '<td class="leaderboard-player-name">' + escapeHtml(tc.score.playerName) + '</td>';
                html += '<td class="text-center leaderboard-section">' + formatNumber(tc.score.handicap) + '</td>';
                html += '<td class="text-right">' + labelStr + '<span class="lb-overall-total">' + formatNumber(tc.par3Strokes) + ' strokes</span></td>';
                html += '</tr>';
              }
            } else {
              html += '<tr>';
              html += '<td class="leaderboard-position">P3</td>';
              html += '<td colspan="3" class="lb-par3-detail">Par-3 data not available for this course.</td>';
              html += '</tr>';
            }
            html += '</tbody></table></div>';
          }

          container.innerHTML = html;
        } catch (err) {
          console.error('Failed to load leaderboard:', err);
          container.innerHTML = '<div class="no-scores"><p style="color: #721c24;">Unable to load leaderboard. Check the console for details.</p></div>';
        }
      })();
    </script>
    <script defer src="assets/js/scripts.min.js"></script>
    <script>
      window.themeMenuConfig = {
        mobileMenuMode: "overlay",
        animationSpeed: 300,
        submenuWidth: "auto",
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true,
        relatedContainerForOverlayMenuSelector: ".top",
      };
    </script>
    <script src="assets/js/utils/nav-active.js"></script>
    <script src="assets/js/utils/preserve-society-param.js"></script>
  </body>
</html>
