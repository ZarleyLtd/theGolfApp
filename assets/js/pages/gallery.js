// Gallery Page (convention-based: albums = year folders + General)
// Uses gallery-manifest.json generated by scripts/generate-gallery-manifest.ps1

const GalleryPage = {
  container: null,
  manifest: null,

  init: function() {
    this.container = document.getElementById("gallery-app");
    if (!this.container) return;

    this.loadManifest();
  },

  loadManifest: function() {
    const url = typeof GalleryConfig !== "undefined"
      ? GalleryConfig.manifestUrl
      : "assets/data/gallery-manifest.json";
    fetch(url)
      .then(function(r) { return r.json(); })
      .then(this.onManifestLoaded.bind(this))
      .catch(this.onManifestError.bind(this));
  },

  onManifestLoaded: function(data) {
    this.manifest = data;
    this.render();
  },

  onManifestError: function(err) {
    this.container.innerHTML = "<p class=\"msg msg--warning\">Unable to load gallery. Please try again later.</p>";
  },

  getAlbumFromUrl: function() {
    const params = new URLSearchParams(window.location.search);
    return params.get("album") || null;
  },

  findAlbum: function(id) {
    if (!this.manifest || !this.manifest.albums) return null;
    return this.manifest.albums.find(function(a) { return a.id === id; }) || null;
  },

  render: function() {
    const albumId = this.getAlbumFromUrl();
    const album = albumId ? this.findAlbum(albumId) : null;

    if (album) {
      this.renderAlbumView(album);
    } else {
      this.renderAlbumList();
    }
  },

  renderAlbumList: function() {
    const albums = this.manifest.albums || [];
    const basePath = (typeof GalleryConfig !== "undefined" && GalleryConfig.basePath) ? GalleryConfig.basePath : "assets/images/Gallery";
    const albumImageUrl = (typeof GalleryConfig !== "undefined" && typeof GalleryConfig.albumImageUrl === "function")
      ? GalleryConfig.albumImageUrl.bind(GalleryConfig)
      : function(id, f) { return basePath + "/" + encodeURIComponent(id) + "/" + encodeURIComponent(f); };

    let html = "<div class=\"gallery-albums\"><div class=\"gallery-albums__grid\">";
    for (let i = 0; i < albums.length; i++) {
      const a = albums[i];
      const coverUrl = albumImageUrl(a.id, a.cover);
      const href = "gallery.html?album=" + encodeURIComponent(a.id);
      const count = (a.images && a.images.length) ? a.images.length : 0;
      html += "<div class=\"gallery-album-card\">";
      html += "<a href=\"" + href + "\" class=\"gallery-album-card__link\">";
      html += "<span class=\"gallery-album-card__img-wrap\"><img src=\"" + escapeAttr(coverUrl) + "\" alt=\"\" loading=\"lazy\" /></span>";
      html += "<span class=\"gallery-album-card__title\">" + escapeHtml(a.name) + "</span>";
      html += "<span class=\"gallery-album-card__count\">" + count + " photo" + (count !== 1 ? "s" : "") + "</span>";
      html += "</a></div>";
    }
    html += "</div></div>";

    this.container.innerHTML = html;
  },

  renderAlbumView: function(album) {
    const basePath = (typeof GalleryConfig !== "undefined" && GalleryConfig.basePath) ? GalleryConfig.basePath : "assets/images/Gallery";
    const albumImageUrl = (typeof GalleryConfig !== "undefined" && typeof GalleryConfig.albumImageUrl === "function")
      ? GalleryConfig.albumImageUrl.bind(GalleryConfig)
      : function(id, f) { return basePath + "/" + encodeURIComponent(id) + "/" + encodeURIComponent(f); };
    const images = album.images || [];

    let html = "<div class=\"gallery-album-view\">";
    html += "<nav class=\"gallery-breadcrumb\"><a href=\"gallery.html\">Gallery</a> <span aria-hidden=\"true\">›</span> <span>" + escapeHtml(album.name) + "</span></nav>";
    html += "<div class=\"gallery-wrapper--wide\"><div class=\"gallery gallery--photos\" data-columns=\"4\" role=\"list\">";
    for (let i = 0; i < images.length; i++) {
      const fn = images[i];
      const src = albumImageUrl(album.id, fn);
      html += "<figure class=\"gallery__item\" role=\"listitem\">";
      html += "<a href=\"" + escapeAttr(src) + "\" data-index=\"" + i + "\" class=\"gallery__item-link\" data-gallery-lightbox>";
      html += "<img src=\"" + escapeAttr(src) + "\" alt=\"Photo " + (i + 1) + "\" loading=\"lazy\" />";
      html += "</a></figure>";
    }
    html += "</div></div></div>";

    this.container.innerHTML = html;
    this.attachLightbox(album, { albumImageUrl: albumImageUrl });
  },

  attachLightbox: function(album, opts) {
    const links = this.container.querySelectorAll("[data-gallery-lightbox]");
    const images = album.images || [];
    if (links.length === 0) return;

    const albumImageUrl = opts && typeof opts.albumImageUrl === "function" ? opts.albumImageUrl : function(id, f) {
      return "assets/images/Gallery/" + encodeURIComponent(id) + "/" + encodeURIComponent(f);
    };
    function photoUrl(i) {
      return albumImageUrl(album.id, images[i]);
    }

    function openLightbox(index) {
      const lb = document.getElementById("gallery-lightbox");
      if (lb) { lb.remove(); }
      const cur = Math.max(0, Math.min(index, images.length - 1));
      const overlay = document.createElement("div");
      overlay.id = "gallery-lightbox";
      overlay.className = "gallery-lightbox";
      overlay.setAttribute("role", "dialog");
      overlay.setAttribute("aria-modal", "true");
      overlay.setAttribute("aria-label", "Photo " + (cur + 1) + " of " + images.length);
      overlay.innerHTML =
        "<button type=\"button\" class=\"gallery-lightbox__close\" aria-label=\"Close\">×</button>" +
        "<button type=\"button\" class=\"gallery-lightbox__prev\" aria-label=\"Previous\">‹</button>" +
        "<button type=\"button\" class=\"gallery-lightbox__next\" aria-label=\"Next\">›</button>" +
        "<div class=\"gallery-lightbox__inner\"><img src=\"" + escapeAttr(photoUrl(cur)) + "\" alt=\"\" /></div>" +
        "<span class=\"gallery-lightbox__counter\">" + (cur + 1) + " / " + images.length + "</span>";

      const img = overlay.querySelector("img");
      const prevBtn = overlay.querySelector(".gallery-lightbox__prev");
      const nextBtn = overlay.querySelector(".gallery-lightbox__next");
      const closeBtn = overlay.querySelector(".gallery-lightbox__close");
      const counter = overlay.querySelector(".gallery-lightbox__counter");

      function update(idx) {
        const i = Math.max(0, Math.min(idx, images.length - 1));
        img.src = photoUrl(i);
        if (counter) counter.textContent = (i + 1) + " / " + images.length;
        overlay.setAttribute("aria-label", "Photo " + (i + 1) + " of " + images.length);
        return i;
      }

      let currentIndex = cur;

      function close() {
        overlay.remove();
        document.documentElement.classList.remove("no-scroll");
        document.body.classList.remove("no-scroll");
        document.removeEventListener("keydown", onKey);
      }

      function onKey(e) {
        if (e.key === "Escape") { close(); return; }
        if (e.key === "ArrowLeft") { e.preventDefault(); currentIndex = update(currentIndex - 1); }
        if (e.key === "ArrowRight") { e.preventDefault(); currentIndex = update(currentIndex + 1); }
      }

      overlay.addEventListener("click", function(e) {
        if (e.target === overlay) close();
        if (e.target === prevBtn) { e.preventDefault(); currentIndex = update(currentIndex - 1); }
        if (e.target === nextBtn) { e.preventDefault(); currentIndex = update(currentIndex + 1); }
      });
      prevBtn.addEventListener("click", function(e) { e.stopPropagation(); });
      nextBtn.addEventListener("click", function(e) { e.stopPropagation(); });
      closeBtn.addEventListener("click", function(e) {
        e.stopPropagation();
        close();
      });
      document.addEventListener("keydown", onKey);
      document.documentElement.classList.add("no-scroll");
      document.body.classList.add("no-scroll");
      document.body.appendChild(overlay);
    }

    for (let i = 0; i < links.length; i++) {
      links[i].addEventListener("click", function(e) {
        e.preventDefault();
        openLightbox(parseInt(this.getAttribute("data-index"), 10));
      });
    }
  }
};

function escapeHtml(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

function escapeAttr(s) {
  return String(s)
    .replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}
