<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Society Admin</title>
    <meta name="description" content="Manage your golf society: players, outings, and courses." />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
      .admin-container {
        max-width: 1400px;
        margin: 2em auto;
        padding: 2em;
      }
      .admin-header {
        margin-bottom: 2em;
        padding-bottom: 1em;
        border-bottom: 2px solid #2dc26b;
      }
      .admin-header h1 {
        margin: 0 0 0.5em 0;
        color: #2dc26b;
      }
      .admin-header p {
        margin: 0;
        color: #666;
      }
      .tabs {
        display: flex;
        gap: 1em;
        margin-bottom: 2em;
        border-bottom: 2px solid #ddd;
      }
      .tab {
        padding: 1em 2em;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 1em;
        color: #666;
        transition: color 0.2s, border-color 0.2s;
      }
      .tab:hover {
        color: #2dc26b;
      }
      .tab.active {
        color: #2dc26b;
        border-bottom-color: #2dc26b;
        font-weight: 600;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5em;
      }
      .section-header h2 {
        margin: 0;
        color: #333;
      }
      .btn {
        padding: 0.75em 1.5em;
        background: #2dc26b;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.2s;
        text-decoration: none;
        display: inline-block;
      }
      .btn:hover {
        background: #25a85a;
      }
      .btn-secondary {
        background: #666;
      }
      .btn-secondary:hover {
        background: #555;
      }
      .btn-danger {
        background: #c33;
      }
      .btn-danger:hover {
        background: #a22;
      }
      .btn-small {
        padding: 0.5em 1em;
        font-size: 0.9em;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2em;
      }
      table th,
      table td {
        padding: 1em;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      table th {
        background: #f5f5f5;
        font-weight: 600;
        color: #333;
      }
      table tr:hover {
        background: #f9f9f9;
      }
      .actions {
        display: flex;
        gap: 0.5em;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        overflow: auto;
      }
      .modal-content {
        background: white;
        margin: 3% auto;
        padding: 2em;
        border-radius: 8px;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5em;
        padding-bottom: 1em;
        border-bottom: 1px solid #ddd;
      }
      .modal-header h2 {
        margin: 0;
        color: #2dc26b;
      }
      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
        width: 30px;
        height: 30px;
      }
      .close:hover {
        color: #000;
      }
      .form-group {
        margin-bottom: 1.5em;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5em;
        font-weight: 600;
        color: #333;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75em;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1em;
        box-sizing: border-box;
      }
      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #2dc26b;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1em;
      }
      .form-group.full-width {
        grid-column: 1 / -1;
      }
      .form-actions {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 1em;
        justify-content: flex-end;
        align-items: center;
        margin-top: 2em;
      }
      .player-name-link {
        background: none;
        border: none;
        color: inherit;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        font-size: 1em;
        padding: 0;
      }
      .player-name-link:hover {
        text-decoration: underline;
        color: #2dc26b;
      }
      .alert {
        padding: 1em;
        margin: 1em 0;
        border-radius: 4px;
      }
      .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .loading {
        text-align: center;
        padding: 3em;
        color: #666;
      }
      .empty-state {
        text-align: center;
        padding: 3em;
        color: #999;
      }
      .pars-indexes-grid {
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        gap: 0.5em;
        margin-top: 0.5em;
      }
      .pars-indexes-grid input {
        width: 100%;
        padding: 0.5em;
        text-align: center;
      }
      .pars-indexes-label {
        grid-column: 1 / -1;
        font-weight: 600;
        margin-top: 1em;
      }
    </style>
  </head>
  <body>
    <header class="top">
      <a class="logo" href="../landing.html" style="display: block; padding: 0.5em 1em;">
        <img src="../assets/images/TGA.png" alt="TGA" width="80" height="40">
      </a>
    </header>
    <main class="page">
      <article class="content">
        <div class="admin-container">
          <div class="admin-header">
            <h1 id="societyName">Society Admin</h1>
            <p id="societyInfo">Loading...</p>
          </div>

          <div id="alert-container"></div>

          <div class="tabs">
            <button class="tab active" onclick="switchTab('players')">Players</button>
            <button class="tab" onclick="switchTab('outings')">Outings</button>
            <button class="tab" onclick="switchTab('courses')">Courses</button>
          </div>

          <!-- Players Tab -->
          <div id="players-tab" class="tab-content active">
            <div class="section-header">
              <h2>Players</h2>
              <button class="btn" onclick="openPlayerModal()">+ Add Player</button>
            </div>
            <div id="players-container">
              <div class="loading">Loading players...</div>
            </div>
          </div>

          <!-- Outings Tab -->
          <div id="outings-tab" class="tab-content">
            <div class="section-header">
              <h2>Outings</h2>
              <button class="btn" onclick="openOutingModal()">+ Add Outing</button>
            </div>
            <div id="outings-container">
              <div class="loading">Loading outings...</div>
            </div>
          </div>

          <!-- Courses Tab -->
          <div id="courses-tab" class="tab-content">
            <div class="section-header">
              <h2>Courses</h2>
              <button class="btn" onclick="openCourseModal()">+ Add Course</button>
            </div>
            <div id="courses-container">
              <div class="loading">Loading courses...</div>
            </div>
          </div>
        </div>
      </article>
    </main>

    <!-- Player Modal -->
    <div id="playerModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="playerModalTitle">Add Player</h2>
          <button class="close" onclick="closePlayerModal()">&times;</button>
        </div>
        <form id="playerForm" onsubmit="savePlayer(event)">
          <div class="form-group">
            <label for="playerName">Player Name *</label>
            <input type="text" id="playerName" required placeholder="e.g., John Doe">
          </div>
          <div class="form-group">
            <label for="playerHandicap">Handicap</label>
            <input type="number" id="playerHandicap" min="0" max="54" step="0.1" value="0">
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closePlayerModal()">Cancel</button>
            <span id="playerDeleteBtnWrap" style="display: none;">
              <button type="button" class="btn btn-danger" onclick="deletePlayerFromModal()">Delete</button>
            </span>
            <button type="submit" class="btn">Save Player</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Outing Modal -->
    <div id="outingModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="outingModalTitle">Add Outing</h2>
          <button class="close" onclick="closeOutingModal()">&times;</button>
        </div>
        <form id="outingForm" onsubmit="saveOuting(event)">
          <div class="form-row">
            <div class="form-group">
              <label for="outingDate">Date *</label>
              <input type="date" id="outingDate" required>
            </div>
            <div class="form-group">
              <label for="outingTime">Time</label>
              <input type="time" id="outingTime">
            </div>
          </div>
          <div class="form-group">
            <label for="golfClubName">Golf Club Name *</label>
            <input type="text" id="golfClubName" required placeholder="e.g., Powerscourt Golf Club">
          </div>
          <div class="form-group">
            <label for="courseName">Course Name *</label>
            <input type="text" id="courseName" required placeholder="e.g., Powerscourt East">
          </div>
          <div class="form-group">
            <label for="courseKey">Course Key (for scorecard)</label>
            <input type="text" id="courseKey" placeholder="e.g., PowerscourtEast">
            <small style="color: #666;">Must match a course name in the Courses tab</small>
          </div>
          <div class="form-group">
            <label for="clubUrl">Club Website URL</label>
            <input type="url" id="clubUrl" placeholder="https://...">
          </div>
          <div class="form-group">
            <label for="mapsUrl">Google Maps URL</label>
            <input type="url" id="mapsUrl" placeholder="https://maps.google.com/...">
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeOutingModal()">Cancel</button>
            <button type="submit" class="btn">Save Outing</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Course Modal -->
    <div id="courseModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="courseModalTitle">Add Course</h2>
          <button class="close" onclick="closeCourseModal()">&times;</button>
        </div>
        <form id="courseForm" onsubmit="saveCourse(event)">
          <div class="form-group">
            <label for="courseNameInput">Course Name *</label>
            <input type="text" id="courseNameInput" required placeholder="e.g., Powerscourt East">
          </div>
          <div class="form-group">
            <label class="pars-indexes-label">Pars (Holes 1-18)</label>
            <div class="pars-indexes-grid">
              <input type="number" id="par1" min="3" max="6" value="4" required>
              <input type="number" id="par2" min="3" max="6" value="4" required>
              <input type="number" id="par3" min="3" max="6" value="4" required>
              <input type="number" id="par4" min="3" max="6" value="4" required>
              <input type="number" id="par5" min="3" max="6" value="4" required>
              <input type="number" id="par6" min="3" max="6" value="4" required>
              <input type="number" id="par7" min="3" max="6" value="4" required>
              <input type="number" id="par8" min="3" max="6" value="4" required>
              <input type="number" id="par9" min="3" max="6" value="4" required>
              <input type="number" id="par10" min="3" max="6" value="4" required>
              <input type="number" id="par11" min="3" max="6" value="4" required>
              <input type="number" id="par12" min="3" max="6" value="4" required>
              <input type="number" id="par13" min="3" max="6" value="4" required>
              <input type="number" id="par14" min="3" max="6" value="4" required>
              <input type="number" id="par15" min="3" max="6" value="4" required>
              <input type="number" id="par16" min="3" max="6" value="4" required>
              <input type="number" id="par17" min="3" max="6" value="4" required>
              <input type="number" id="par18" min="3" max="6" value="4" required>
            </div>
          </div>
          <div class="form-group">
            <label class="pars-indexes-label">Stroke Indexes (Holes 1-18)</label>
            <div class="pars-indexes-grid">
              <input type="number" id="index1" min="1" max="18" value="1" required>
              <input type="number" id="index2" min="1" max="18" value="2" required>
              <input type="number" id="index3" min="1" max="18" value="3" required>
              <input type="number" id="index4" min="1" max="18" value="4" required>
              <input type="number" id="index5" min="1" max="18" value="5" required>
              <input type="number" id="index6" min="1" max="18" value="6" required>
              <input type="number" id="index7" min="1" max="18" value="7" required>
              <input type="number" id="index8" min="1" max="18" value="8" required>
              <input type="number" id="index9" min="1" max="18" value="9" required>
              <input type="number" id="index10" min="1" max="18" value="10" required>
              <input type="number" id="index11" min="1" max="18" value="11" required>
              <input type="number" id="index12" min="1" max="18" value="12" required>
              <input type="number" id="index13" min="1" max="18" value="13" required>
              <input type="number" id="index14" min="1" max="18" value="14" required>
              <input type="number" id="index15" min="1" max="18" value="15" required>
              <input type="number" id="index16" min="1" max="18" value="16" required>
              <input type="number" id="index17" min="1" max="18" value="17" required>
              <input type="number" id="index18" min="1" max="18" value="18" required>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeCourseModal()">Cancel</button>
            <button type="submit" class="btn">Save Course</button>
          </div>
        </form>
      </div>
    </div>

    <footer class="footer">
      <div class="wrapper">
        <div class="footer__copyright">
          <p><span style="color: #169179;">Society Admin Panel</span></p>
        </div>
      </div>
    </footer>

    <script src="../assets/js/config/app-config.js"></script>
    <script src="../assets/js/utils/api-client.js"></script>
    <script>
      let currentSocietyId = null;
      let maxPlayers = 0;   // 0 = no limit (from Societies sheet NumberOfPlayers)
      let maxCourses = 0;   // 0 = no limit (from Societies sheet NumberOfCourses)
      let players = [];
      let outings = [];
      let courses = {};
      let editingItem = null;

      // Initialize
      (async function() {
        await AppConfig.init();
        currentSocietyId = AppConfig.getSocietyId();
        
        // Fallback: try to get from query parameter
        if (!currentSocietyId) {
          const params = new URLSearchParams(window.location.search);
          currentSocietyId = params.get('societyId');
        }
        
        if (!currentSocietyId) {
          document.getElementById('societyInfo').textContent = 'Error: No society ID found. Access via /theGolfApp/<society-id>/admin/ or ?societyId=<id>';
          return;
        }

        // Ensure AppConfig has the society ID so ApiClient.get/post use it (path or query param)
        currentSocietyId = (currentSocietyId || '').toLowerCase();
        AppConfig.currentSocietyId = currentSocietyId;

        // Load society info
        try {
          const societyResult = await ApiClient.get({ action: 'getSociety' });
          if (societyResult.success && societyResult.society) {
            const s = societyResult.society;
            maxPlayers = parseInt(s.numberOfPlayers, 10) || 0;
            maxCourses = parseInt(s.numberOfCourses, 10) || 0;
            document.getElementById('societyName').textContent = s.societyName + ' - Admin';
            document.getElementById('societyInfo').textContent = 
              `Contact: ${s.contactPerson || 'N/A'} | ` +
              `Players: ${s.numberOfPlayers || 0} | ` +
              `Courses: ${s.numberOfCourses || 0}`;
          }
        } catch (error) {
          console.error('Error loading society:', error);
        }

        // Load all data
        loadPlayers();
        loadOutings();
        loadCourses();
      })();

      // Tab switching
      function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
      }

      // ========== PLAYERS ==========
      async function loadPlayers() {
        const container = document.getElementById('players-container');
        try {
          const result = await ApiClient.get({ action: 'getPlayers' });
          if (result.success) {
            players = result.players || [];
            renderPlayers();
          } else {
            showAlert('error', 'Failed to load players: ' + (result.error || 'Unknown error'));
            container.innerHTML = '<div class="empty-state">Error loading players</div>';
          }
        } catch (error) {
          console.error('Error loading players:', error);
          showAlert('error', 'Error loading players: ' + error.message);
          container.innerHTML = '<div class="empty-state">Error loading players</div>';
        }
      }

      function renderPlayers() {
        const container = document.getElementById('players-container');
        if (players.length === 0) {
          container.innerHTML = '<div class="empty-state">No players yet. Click "Add Player" to add one.</div>';
          return;
        }

        let html = '<table><thead><tr><th>Player Name</th><th>Handicap</th></tr></thead><tbody>';
        players.forEach(player => {
          const safeName = escapeJsString(player.playerName);
          html += '<tr>';
          html += `<td><button type="button" class="player-name-link" onclick="editPlayer('${safeName}')">${escapeHtml(player.playerName)}</button></td>`;
          html += `<td>${player.handicap || 0}</td>`;
          html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function openPlayerModal() {
        editingItem = null;
        if (maxPlayers > 0 && players.length >= maxPlayers) {
          showAlert('error', 'There are already the maximum number of players set up for this society (' + maxPlayers + ').');
          return;
        }
        document.getElementById('playerModalTitle').textContent = 'Add Player';
        document.getElementById('playerForm').reset();
        document.getElementById('playerDeleteBtnWrap').style.display = 'none';
        document.getElementById('playerModal').style.display = 'block';
      }

      function closePlayerModal() {
        document.getElementById('playerModal').style.display = 'none';
        editingItem = null;
      }

      function editPlayer(playerName) {
        const player = players.find(p => p.playerName === playerName);
        if (!player) return;
        
        editingItem = player;
        document.getElementById('playerModalTitle').textContent = 'Edit Player';
        document.getElementById('playerName').value = player.playerName;
        document.getElementById('playerHandicap').value = player.handicap || 0;
        document.getElementById('playerDeleteBtnWrap').style.display = 'inline-block';
        document.getElementById('playerModal').style.display = 'block';
      }

      function deletePlayerFromModal() {
        const name = editingItem ? editingItem.playerName : document.getElementById('playerName').value.trim();
        if (!name) return;
        closePlayerModal();
        deletePlayer(name);
      }

      async function savePlayer(event) {
        event.preventDefault();
        const playerName = document.getElementById('playerName').value.trim();
        const handicap = parseFloat(document.getElementById('playerHandicap').value) || 0;

        try {
          const result = await ApiClient.post('savePlayer', {
            playerName: playerName,
            handicap: handicap
          });

          if (result.success) {
            showAlert('success', 'Player saved successfully');
            closePlayerModal();
            loadPlayers();
          } else {
            showAlert('error', 'Failed to save player: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error saving player:', error);
          showAlert('error', 'Error saving player: ' + error.message);
        }
      }

      async function deletePlayer(playerName) {
        if (!confirm(`Delete player "${playerName}"?`)) return;

        try {
          const result = await ApiClient.post('deletePlayer', {
            playerName: playerName
          });

          if (result.success) {
            showAlert('success', 'Player deleted successfully');
            loadPlayers();
          } else {
            showAlert('error', 'Failed to delete player: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error deleting player:', error);
          showAlert('error', 'Error deleting player: ' + error.message);
        }
      }

      // ========== OUTINGS ==========
      async function loadOutings() {
        const container = document.getElementById('outings-container');
        try {
          const result = await ApiClient.get({ action: 'getOutings' });
          if (result.success) {
            outings = result.outings || [];
            renderOutings();
          } else {
            showAlert('error', 'Failed to load outings: ' + (result.error || 'Unknown error'));
            container.innerHTML = '<div class="empty-state">Error loading outings</div>';
          }
        } catch (error) {
          console.error('Error loading outings:', error);
          showAlert('error', 'Error loading outings: ' + error.message);
          container.innerHTML = '<div class="empty-state">Error loading outings</div>';
        }
      }

      function renderOutings() {
        const container = document.getElementById('outings-container');
        if (outings.length === 0) {
          container.innerHTML = '<div class="empty-state">No outings yet. Click "Add Outing" to add one.</div>';
          return;
        }

        let html = '<table><thead><tr><th>Date</th><th>Time</th><th>Golf Club</th><th>Course</th><th>Actions</th></tr></thead><tbody>';
        outings.forEach(outing => {
          html += '<tr>';
          html += `<td>${escapeHtml(outing.date || '')}</td>`;
          html += `<td>${escapeHtml(outing.time || '')}</td>`;
          html += `<td>${escapeHtml(outing.golfClubName || '')}</td>`;
          html += `<td>${escapeHtml(outing.courseName || '')}</td>`;
          html += '<td class="actions">';
          html += `<button class="btn btn-secondary btn-small" onclick="editOuting('${escapeHtml(outing.date)}', '${escapeHtml(outing.golfClubName)}')">Edit</button>`;
          html += `<button class="btn btn-danger btn-small" onclick="deleteOuting('${escapeHtml(outing.date)}', '${escapeHtml(outing.golfClubName)}')">Delete</button>`;
          html += '</td></tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function openOutingModal() {
        editingItem = null;
        document.getElementById('outingModalTitle').textContent = 'Add Outing';
        document.getElementById('outingForm').reset();
        document.getElementById('outingDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('outingModal').style.display = 'block';
      }

      function closeOutingModal() {
        document.getElementById('outingModal').style.display = 'none';
        editingItem = null;
      }

      function editOuting(date, golfClubName) {
        const outing = outings.find(o => o.date === date && o.golfClubName === golfClubName);
        if (!outing) return;
        
        editingItem = outing;
        document.getElementById('outingModalTitle').textContent = 'Edit Outing';
        document.getElementById('outingDate').value = outing.date || '';
        document.getElementById('outingTime').value = outing.time || '';
        document.getElementById('golfClubName').value = outing.golfClubName || '';
        document.getElementById('courseName').value = outing.courseName || '';
        document.getElementById('courseKey').value = outing.courseKey || '';
        document.getElementById('clubUrl').value = outing.clubUrl || '';
        document.getElementById('mapsUrl').value = outing.mapsUrl || '';
        document.getElementById('outingModal').style.display = 'block';
      }

      async function saveOuting(event) {
        event.preventDefault();
        const data = {
          date: document.getElementById('outingDate').value,
          time: document.getElementById('outingTime').value,
          golfClubName: document.getElementById('golfClubName').value.trim(),
          courseName: document.getElementById('courseName').value.trim(),
          courseKey: document.getElementById('courseKey').value.trim(),
          clubUrl: document.getElementById('clubUrl').value.trim(),
          mapsUrl: document.getElementById('mapsUrl').value.trim()
        };

        try {
          const result = await ApiClient.post('saveOuting', data);

          if (result.success) {
            showAlert('success', 'Outing saved successfully');
            closeOutingModal();
            loadOutings();
          } else {
            showAlert('error', 'Failed to save outing: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error saving outing:', error);
          showAlert('error', 'Error saving outing: ' + error.message);
        }
      }

      async function deleteOuting(date, golfClubName) {
        if (!confirm(`Delete outing on ${date} at ${golfClubName}?`)) return;

        try {
          const result = await ApiClient.post('deleteOuting', {
            date: date,
            golfClubName: golfClubName
          });

          if (result.success) {
            showAlert('success', 'Outing deleted successfully');
            loadOutings();
          } else {
            showAlert('error', 'Failed to delete outing: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error deleting outing:', error);
          showAlert('error', 'Error deleting outing: ' + error.message);
        }
      }

      // ========== COURSES ==========
      async function loadCourses() {
        const container = document.getElementById('courses-container');
        try {
          const result = await ApiClient.get({ action: 'getCourses' });
          if (result.success) {
            courses = result.courses || {};
            renderCourses();
          } else {
            showAlert('error', 'Failed to load courses: ' + (result.error || 'Unknown error'));
            container.innerHTML = '<div class="empty-state">Error loading courses</div>';
          }
        } catch (error) {
          console.error('Error loading courses:', error);
          showAlert('error', 'Error loading courses: ' + error.message);
          container.innerHTML = '<div class="empty-state">Error loading courses</div>';
        }
      }

      function renderCourses() {
        const container = document.getElementById('courses-container');
        const courseNames = Object.keys(courses);
        
        if (courseNames.length === 0) {
          container.innerHTML = '<div class="empty-state">No courses yet. Click "Add Course" to add one.</div>';
          return;
        }

        let html = '<table><thead><tr><th>Course Name</th><th>Par</th><th>Actions</th></tr></thead><tbody>';
        courseNames.forEach(courseName => {
          const course = courses[courseName];
          const totalPar = course.pars ? course.pars.reduce((a, b) => a + b, 0) : 0;
          html += '<tr>';
          html += `<td><strong>${escapeHtml(courseName)}</strong></td>`;
          html += `<td>${totalPar}</td>`;
          html += '<td class="actions">';
          html += `<button class="btn btn-secondary btn-small" onclick="editCourse('${escapeHtml(courseName)}')">Edit</button>`;
          html += `<button class="btn btn-danger btn-small" onclick="deleteCourse('${escapeHtml(courseName)}')">Delete</button>`;
          html += '</td></tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function openCourseModal() {
        editingItem = null;
        const courseCount = Object.keys(courses).length;
        if (maxCourses > 0 && courseCount >= maxCourses) {
          showAlert('error', 'There are already the maximum number of courses set up for this society (' + maxCourses + ').');
          return;
        }
        document.getElementById('courseModalTitle').textContent = 'Add Course';
        document.getElementById('courseForm').reset();
        // Set default pars and indexes
        for (let i = 1; i <= 18; i++) {
          document.getElementById('par' + i).value = 4;
          document.getElementById('index' + i).value = i;
        }
        document.getElementById('courseModal').style.display = 'block';
      }

      function closeCourseModal() {
        document.getElementById('courseModal').style.display = 'none';
        editingItem = null;
      }

      function editCourse(courseName) {
        const course = courses[courseName];
        if (!course) return;
        
        editingItem = { courseName: courseName, ...course };
        document.getElementById('courseModalTitle').textContent = 'Edit Course';
        document.getElementById('courseNameInput').value = courseName;
        
        for (let i = 1; i <= 18; i++) {
          document.getElementById('par' + i).value = course.pars ? course.pars[i - 1] : 4;
          document.getElementById('index' + i).value = course.indexes ? course.indexes[i - 1] : i;
        }
        
        document.getElementById('courseModal').style.display = 'block';
      }

      async function saveCourse(event) {
        event.preventDefault();
        const courseName = document.getElementById('courseNameInput').value.trim();
        const pars = [];
        const indexes = [];
        
        for (let i = 1; i <= 18; i++) {
          pars.push(parseInt(document.getElementById('par' + i).value) || 4);
          indexes.push(parseInt(document.getElementById('index' + i).value) || i);
        }

        try {
          const result = await ApiClient.post('saveCourse', {
            courseName: courseName,
            pars: pars,
            indexes: indexes
          });

          if (result.success) {
            showAlert('success', 'Course saved successfully');
            closeCourseModal();
            loadCourses();
          } else {
            showAlert('error', 'Failed to save course: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error saving course:', error);
          showAlert('error', 'Error saving course: ' + error.message);
        }
      }

      async function deleteCourse(courseName) {
        if (!confirm(`Delete course "${courseName}"?`)) return;

        try {
          const result = await ApiClient.post('deleteCourse', {
            courseName: courseName
          });

          if (result.success) {
            showAlert('success', 'Course deleted successfully');
            loadCourses();
          } else {
            showAlert('error', 'Failed to delete course: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error deleting course:', error);
          showAlert('error', 'Error deleting course: ' + error.message);
        }
      }

      // Utility functions
      function showAlert(type, message) {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        container.innerHTML = '';
        container.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function escapeJsString(text) {
        if (text == null) return '';
        return String(text)
          .replace(/\\/g, '\\\\')
          .replace(/'/g, "\\'")
          .replace(/\r/g, '')
          .replace(/\n/g, '\\n');
      }

      // Close modals when clicking outside
      window.onclick = function(event) {
        ['playerModal', 'outingModal', 'courseModal'].forEach(modalId => {
          const modal = document.getElementById(modalId);
          if (event.target === modal) {
            if (modalId === 'playerModal') closePlayerModal();
            else if (modalId === 'outingModal') closeOutingModal();
            else if (modalId === 'courseModal') closeCourseModal();
          }
        });
      }
    </script>
  </body>
</html>
