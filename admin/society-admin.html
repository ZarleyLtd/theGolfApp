<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Society Admin</title>
    <meta name="description" content="Manage your golf society: players, outings, and courses." />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
      body {
        background: #f5f5f5;
      }
      .admin-hero-top {
        margin-top: 0;
        position: relative;
      }
      .admin-hero-logo {
        position: absolute;
        top: 0.75rem;
        left: 0.75rem;
        z-index: 2;
      }
      .admin-hero-logo a {
        display: block;
      }
      .admin-hero-logo img {
        display: block;
        height: 2.5rem;
        width: auto;
      }
      .admin-container {
        max-width: 1400px;
        margin: 2em auto;
        padding: 2em;
      }
      .admin-header {
        margin-bottom: 2em;
        padding-bottom: 1em;
        border-bottom: 2px solid #2dc26b;
      }
      .admin-header h1 {
        margin: 0 0 0.5em 0;
        color: #2dc26b;
      }
      .admin-header p {
        margin: 0;
        color: #666;
      }
      .tabs {
        display: flex;
        flex-direction: row;
        align-items: stretch;
        gap: 0.75em;
        margin-bottom: 2em;
        background: white;
        padding: 0.5em;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .tab {
        flex: 1 1 0;
        min-width: 0;
        padding: 1em 1.5em;
        background: transparent;
        border: 2px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 500;
        color: #666;
        transition: all 0.3s ease;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
      }
      .tab:hover {
        background: #f0f0f0;
        color: #2dc26b;
      }
      .tab.active {
        background: #2dc26b;
        color: white;
        border-color: #2dc26b;
        box-shadow: 0 2px 6px rgba(45, 194, 107, 0.3);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5em;
      }
      .section-header h2 {
        margin: 0;
        color: #333;
      }
      .btn {
        padding: 0.75em 1.5em;
        background: #2dc26b;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.2s;
        text-decoration: none;
        display: inline-block;
      }
      .btn:hover {
        background: #25a85a;
      }
      .btn:disabled {
        background: #999;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .btn:disabled:hover {
        background: #999;
      }
      .btn-secondary {
        background: #666;
      }
      .btn-secondary:hover {
        background: #555;
      }
      .btn-danger {
        background: #c33;
      }
      .btn-danger:hover {
        background: #a22;
      }
      .btn-small {
        padding: 0.5em 1em;
        font-size: 0.9em;
      }
      .players-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5em;
        margin-bottom: 2em;
      }
      .player-card {
        background: #2a2a2a;
        border-radius: 12px;
        padding: 1.5em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        border: 2px solid transparent;
      }
      .player-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        border-color: #2dc26b;
      }
      .player-card-name {
        font-size: 1.25em;
        font-weight: 600;
        color: white;
        margin-bottom: 0.5em;
      }
      .player-card-handicap {
        font-size: 0.95em;
        color: #b0b0b0;
      }
      .player-card-handicap strong {
        color: #2dc26b;
        font-weight: 600;
      }
      .outings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5em;
        margin-bottom: 2em;
      }
      .outing-card {
        background: #2a2a2a;
        border-radius: 12px;
        padding: 1.5em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        border: 2px solid transparent;
      }
      .outing-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        border-color: #2dc26b;
      }
      .outing-card-course {
        font-size: 1.25em;
        font-weight: 600;
        color: white;
        margin-bottom: 0.5em;
      }
      .outing-card-datetime {
        font-size: 0.95em;
        color: #b0b0b0;
        margin-bottom: 0.5em;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2em;
      }
      table th,
      table td {
        padding: 1em;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      table th {
        background: #f5f5f5;
        font-weight: 600;
        color: #333;
      }
      table tr:hover {
        background: #f9f9f9;
      }
      .actions {
        display: flex;
        gap: 0.5em;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        overflow: auto;
      }
      .modal-content {
        background: white;
        margin: 3% auto;
        padding: 2em;
        border-radius: 8px;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5em;
        padding-bottom: 1em;
        border-bottom: 1px solid #ddd;
      }
      .modal-header h2 {
        margin: 0;
        color: #2dc26b;
      }
      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
        width: 30px;
        height: 30px;
      }
      .close:hover {
        color: #000;
      }
      .form-group {
        margin-bottom: 1.5em;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5em;
        font-weight: 600;
        color: #333;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.75em;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1em;
        box-sizing: border-box;
        font-family: inherit;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #2dc26b;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1em;
      }
      .form-group.full-width {
        grid-column: 1 / -1;
      }
      .form-actions {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 1em;
        justify-content: flex-end;
        align-items: center;
        margin-top: 2em;
      }
      .alert {
        padding: 1em;
        margin: 1em 0;
        border-radius: 4px;
      }
      .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .loading {
        text-align: center;
        padding: 3em;
        color: #666;
      }
      .empty-state {
        text-align: center;
        padding: 3em;
        color: #999;
      }
    </style>
  </head>
  <body class="page-template has-hero-banner">
    <div class="hero hero--banner admin-hero-top">
      <div class="admin-hero-logo">
        <a href="../index.html">
          <img src="../assets/images/TGA.png" alt="TGA" width="80" height="40" />
        </a>
      </div>
      <figure class="hero__image">
        <div class="hero__image-wrapper">
          <img src="../assets/images/golfBanner.jpg" loading="eager" alt="Golf course" />
        </div>
      </figure>
      <header class="hero__content hero__content--overlay">
        <div class="wrapper">
          <h1 id="societyName">Society Admin</h1>
        </div>
      </header>
    </div>
    <main class="page has-hero-banner">
      <article class="content">
        <div class="admin-container">
          <div class="admin-header">
            <p id="societyInfo">Loading...</p>
          </div>

          <div id="alert-container"></div>

          <div class="tabs">
            <button class="tab active" onclick="switchTab('players')">Players</button>
            <button class="tab" onclick="switchTab('outings')">Outings</button>
          </div>

          <!-- Players Tab -->
          <div id="players-tab" class="tab-content active">
            <div class="section-header">
              <h2>Players</h2>
              <button class="btn" onclick="openPlayerModal()">+ Add Player</button>
            </div>
            <div id="players-container">
              <div class="loading">Loading players...</div>
            </div>
          </div>

          <!-- Outings Tab -->
          <div id="outings-tab" class="tab-content">
            <div class="section-header">
              <h2>Outings</h2>
              <button class="btn" onclick="openOutingModal()">+ Add Outing</button>
            </div>
            <div id="outings-container">
              <div class="loading">Loading outings...</div>
            </div>
          </div>

        </div>
      </article>
    </main>

    <!-- Player Modal -->
    <div id="playerModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="playerModalTitle">Add Player</h2>
          <button class="close" onclick="closePlayerModal()">&times;</button>
        </div>
        <form id="playerForm" onsubmit="savePlayer(event)">
          <div class="form-group">
            <label for="playerName">Player Name *</label>
            <input type="text" id="playerName" required placeholder="e.g., John Doe">
          </div>
          <div class="form-group">
            <label for="playerHandicap">Handicap</label>
            <input type="number" id="playerHandicap" min="0" max="54" step="0.1" value="0">
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closePlayerModal()">Cancel</button>
            <span id="playerDeleteBtnWrap" style="display: none;">
              <button type="button" class="btn btn-danger" onclick="deletePlayerFromModal()">Delete</button>
            </span>
            <button type="submit" class="btn">Save Player</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Outing Modal -->
    <div id="outingModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="outingModalTitle">Add Outing</h2>
          <button class="close" onclick="closeOutingModal()">&times;</button>
        </div>
        <form id="outingForm" onsubmit="saveOuting(event)">
          <div class="form-row">
            <div class="form-group">
              <label for="outingDate">Date *</label>
              <input type="date" id="outingDate" required>
            </div>
            <div class="form-group">
              <label for="outingTime">Time</label>
              <input type="time" id="outingTime">
            </div>
          </div>
          <div class="form-group">
            <label for="outingCourseName">Course Name *</label>
            <select id="outingCourseName" required>
              <option value="">Select a course...</option>
            </select>
            <small style="color: #666;">Course must exist in the Courses sheet</small>
          </div>
          <div class="form-group">
            <label for="outingNotes">Notes</label>
            <textarea id="outingNotes" rows="3" placeholder="Additional notes about this outing..."></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeOutingModal()">Cancel</button>
            <span id="outingDeleteBtnWrap" style="display: none;">
              <button type="button" class="btn btn-danger" onclick="deleteOutingFromModal()">Delete</button>
            </span>
            <button type="submit" class="btn" id="outingSaveBtn">Save Outing</button>
          </div>
        </form>
      </div>
    </div>

    <footer class="footer">
      <div class="wrapper">
        <div class="footer__copyright">
          <p><span style="color: #169179;">Society Admin Panel</span></p>
        </div>
      </div>
    </footer>

    <script src="../assets/js/config/app-config.js"></script>
    <script src="../assets/js/utils/api-client.js"></script>
    <script>
      let currentSocietyId = null;
      let societyValid = false;  // true only after getSociety returns a valid society
      let maxPlayers = 0;   // 0 = no limit (from Societies sheet NumberOfPlayers)
      let maxCourses = 0;   // 0 = no limit (from Societies sheet NumberOfCourses - refers to Outings, not Courses)
      let players = [];
      let outings = [];
      let courses = {};
      let editingItem = null;

      function showSocietyError(message) {
        societyValid = false;
        document.getElementById('societyName').textContent = 'Society Admin';
        document.getElementById('societyInfo').textContent = message;
        showAlert('error', message);
        // Disable tabs
        document.querySelectorAll('.tab').forEach(tab => { tab.disabled = true; tab.style.pointerEvents = 'none'; tab.style.opacity = '0.6'; });
        // Disable Add Player / Add Outing
        document.querySelectorAll('.section-header .btn').forEach(btn => { btn.disabled = true; });
        // Replace content with error state
        document.getElementById('players-container').innerHTML = '<div class="empty-state">Society not found. All functions are disabled.</div>';
        document.getElementById('outings-container').innerHTML = '<div class="empty-state">Society not found. All functions are disabled.</div>';
      }

      // Initialize
      (async function() {
        await AppConfig.init();
        currentSocietyId = AppConfig.getSocietyId();
        
        // Fallback: try to get from query parameter (support both societyId and typo sociietyId)
        if (!currentSocietyId) {
          const params = new URLSearchParams(window.location.search);
          currentSocietyId = params.get('societyId') || params.get('sociietyId');
        }

        // Never treat reserved path segments (e.g. "admin") as a society ID
        const reservedIds = ['admin', 'assets', 'docs', 'backend'];
        currentSocietyId = (currentSocietyId || '').trim().toLowerCase();
        if (!currentSocietyId || reservedIds.includes(currentSocietyId)) {
          currentSocietyId = null;
        }
        
        if (!currentSocietyId) {
          document.getElementById('societyInfo').textContent = 'Error: No society ID found. Access via /theGolfApp/<society-id>/admin/ or ?societyId=<id>';
          showAlert('error', 'No society ID found. Access via /theGolfApp/<society-id>/admin/ or ?societyId=<id>');
          return;
        }

        // Ensure AppConfig has the society ID so ApiClient.get/post use it (path or query param)
        AppConfig.currentSocietyId = currentSocietyId;

        // Load society info and validate that the society exists
        try {
          const societyResult = await ApiClient.get({ action: 'getSociety' });
          if (!societyResult.success || !societyResult.society) {
            const errMsg = societyResult.error || 'Society not found';
            showSocietyError(errMsg);
            return;
          }
          const s = societyResult.society;
          societyValid = true;
          maxPlayers = parseInt(s.numberOfPlayers, 10) || 0;
          maxCourses = parseInt(s.numberOfCourses, 10) || 0;
          document.getElementById('societyName').textContent = s.societyName + ' Admin';
          document.getElementById('societyInfo').textContent = 
            `Contact: ${s.contactPerson || 'N/A'} | ` +
            `Players: ${s.numberOfPlayers || 0} | ` +
            `Outings: ${s.numberOfCourses || 0}`;
        } catch (error) {
          console.error('Error loading society:', error);
          showSocietyError('Error loading society: ' + (error.message || 'Unknown error'));
          return;
        }

        // Load all data
        loadPlayers();
        loadOutings();
      })();

      // Tab switching
      function switchTab(tabName) {
        if (!societyValid) return;
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        if (event && event.target) event.target.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
      }

      // ========== PLAYERS ==========
      async function loadPlayers() {
        const container = document.getElementById('players-container');
        try {
          const result = await ApiClient.get({ action: 'getPlayers' });
          if (result.success) {
            players = result.players || [];
            renderPlayers();
          } else {
            showAlert('error', 'Failed to load players: ' + (result.error || 'Unknown error'));
            container.innerHTML = '<div class="empty-state">Error loading players</div>';
          }
        } catch (error) {
          console.error('Error loading players:', error);
          showAlert('error', 'Error loading players: ' + error.message);
          container.innerHTML = '<div class="empty-state">Error loading players</div>';
        }
      }

      function renderPlayers() {
        const container = document.getElementById('players-container');
        if (players.length === 0) {
          container.innerHTML = '<div class="empty-state">No players yet. Click "Add Player" to add one.</div>';
          return;
        }

        let html = '<div class="players-grid">';
        players.forEach(player => {
          const safeName = escapeJsString(player.playerName);
          html += `<div class="player-card" onclick="editPlayer('${safeName}')">`;
          html += `<div class="player-card-name">${escapeHtml(player.playerName)}</div>`;
          html += `<div class="player-card-handicap">Handicap: <strong>${player.handicap || 0}</strong></div>`;
          html += '</div>';
        });
        html += '</div>';
        container.innerHTML = html;
      }

      function openPlayerModal() {
        if (!societyValid) return;
        editingItem = null;
        if (maxPlayers > 0 && players.length >= maxPlayers) {
          showAlert('error', 'There are already the maximum number of players set up for this society (' + maxPlayers + ').');
          return;
        }
        document.getElementById('playerModalTitle').textContent = 'Add Player';
        document.getElementById('playerForm').reset();
        document.getElementById('playerDeleteBtnWrap').style.display = 'none';
        document.getElementById('playerModal').style.display = 'block';
      }

      function closePlayerModal() {
        document.getElementById('playerModal').style.display = 'none';
        editingItem = null;
      }

      function editPlayer(playerName) {
        if (!societyValid) return;
        const player = players.find(p => p.playerName === playerName);
        if (!player) return;
        
        editingItem = player;
        document.getElementById('playerModalTitle').textContent = 'Edit Player';
        document.getElementById('playerName').value = player.playerName;
        document.getElementById('playerHandicap').value = player.handicap || 0;
        document.getElementById('playerDeleteBtnWrap').style.display = 'inline-block';
        document.getElementById('playerModal').style.display = 'block';
      }

      function deletePlayerFromModal() {
        if (!societyValid) return;
        const name = editingItem ? editingItem.playerName : document.getElementById('playerName').value.trim();
        if (!name) return;
        closePlayerModal();
        deletePlayer(name);
      }

      async function savePlayer(event) {
        event.preventDefault();
        if (!societyValid) return;
        const playerName = document.getElementById('playerName').value.trim();
        const handicap = parseFloat(document.getElementById('playerHandicap').value) || 0;

        try {
          const result = await ApiClient.post('savePlayer', {
            playerName: playerName,
            handicap: handicap
          });

          if (result.success) {
            showAlert('success', 'Player saved successfully');
            closePlayerModal();
            loadPlayers();
          } else {
            showAlert('error', 'Failed to save player: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error saving player:', error);
          showAlert('error', 'Error saving player: ' + error.message);
        }
      }

      async function deletePlayer(playerName) {
        if (!societyValid) return;
        if (!confirm(`Delete player "${playerName}"?`)) return;

        try {
          const result = await ApiClient.post('deletePlayer', {
            playerName: playerName
          });

          if (result.success) {
            showAlert('success', 'Player deleted successfully');
            loadPlayers();
          } else {
            showAlert('error', 'Failed to delete player: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error deleting player:', error);
          showAlert('error', 'Error deleting player: ' + error.message);
        }
      }

      // ========== OUTINGS ==========
      async function loadOutings() {
        const container = document.getElementById('outings-container');
        try {
          const result = await ApiClient.get({ action: 'getOutings' });
          if (result.success) {
            outings = result.outings || [];
            renderOutings();
          } else {
            showAlert('error', 'Failed to load outings: ' + (result.error || 'Unknown error'));
            container.innerHTML = '<div class="empty-state">Error loading outings</div>';
          }
        } catch (error) {
          console.error('Error loading outings:', error);
          showAlert('error', 'Error loading outings: ' + error.message);
          container.innerHTML = '<div class="empty-state">Error loading outings</div>';
        }
      }

      function formatOutingDateTime(dateStr, timeStr) {
        if (!dateStr) return '';
        
        // Handle Date objects or strings
        let date;
        if (dateStr instanceof Date) {
          date = dateStr;
        } else {
          // Try parsing as ISO date string (YYYY-MM-DD)
          const dateStrClean = String(dateStr).trim();
          date = new Date(dateStrClean);
          if (isNaN(date.getTime())) {
            // Fallback: try other formats
            return dateStrClean + (timeStr ? ' ' + timeStr : '');
          }
        }
        
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        const dayName = days[date.getDay()];
        const day = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear();
        
        // Add ordinal suffix (1st, 2nd, 3rd, 4th, etc.)
        const getOrdinal = (n) => {
          const s = ['th', 'st', 'nd', 'rd'];
          const v = n % 100;
          return n + (s[(v - 20) % 10] || s[v] || s[0]);
        };
        
        let formatted = `${dayName}, ${getOrdinal(day)} ${month} ${year}`;
        
        if (timeStr) {
          // Handle time string - could be "10:30" or "10:30:00" or a Date object
          let timeStrClean = String(timeStr).trim();
          
          // If it's a Date object, extract time
          if (timeStr instanceof Date) {
            const hours = timeStr.getHours();
            const minutes = timeStr.getMinutes();
            timeStrClean = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
          }
          
          // Parse time string (HH:MM or HH:MM:SS)
          const timeMatch = timeStrClean.match(/(\d{1,2}):(\d{2})/);
          if (timeMatch) {
            const h = parseInt(timeMatch[1], 10);
            const m = timeMatch[2];
            const ampm = h >= 12 ? 'pm' : 'am';
            const displayHour = h % 12 || 12;
            formatted += ` @${displayHour}:${m}${ampm}`;
          }
        }
        
        return formatted;
      }

      function renderOutings() {
        const container = document.getElementById('outings-container');
        if (outings.length === 0) {
          container.innerHTML = '<div class="empty-state">No outings yet. Click "Add Outing" to add one.</div>';
          return;
        }

        let html = '<div class="outings-grid">';
        outings.forEach(outing => {
          // Convert date/time to strings if they're Date objects
          const dateStr = outing.date instanceof Date ? outing.date.toISOString().split('T')[0] : String(outing.date || '').trim();
          const timeStr = outing.time instanceof Date ? 
            `${outing.time.getHours().toString().padStart(2, '0')}:${outing.time.getMinutes().toString().padStart(2, '0')}` : 
            String(outing.time || '').trim();
          
          const safeDate = escapeJsString(dateStr);
          const safeCourse = escapeJsString(outing.courseName || '');
          const datetime = formatOutingDateTime(dateStr, timeStr);
          
          html += `<div class="outing-card" onclick="editOuting('${safeDate}', '${safeCourse}')">`;
          html += `<div class="outing-card-course">${escapeHtml(outing.courseName || '')}</div>`;
          html += `<div class="outing-card-datetime">${escapeHtml(datetime)}</div>`;
          html += '</div>';
        });
        html += '</div>';
        container.innerHTML = html;
      }

      async function openOutingModal() {
        if (!societyValid) return;
        editingItem = null;
        if (maxCourses > 0 && outings.length >= maxCourses) {
          showAlert('error', 'There are already the maximum number of outings set up for this society (' + maxCourses + ').');
          return;
        }
        document.getElementById('outingModalTitle').textContent = 'Add Outing';
        document.getElementById('outingForm').reset();
        document.getElementById('outingDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('outingDeleteBtnWrap').style.display = 'none';
        document.getElementById('outingSaveBtn').disabled = false;
        document.getElementById('outingSaveBtn').textContent = 'Save Outing';
        
        // Populate course dropdown
        await populateCourseDropdown();
        
        document.getElementById('outingModal').style.display = 'block';
      }
      
      async function populateCourseDropdown() {
        const select = document.getElementById('outingCourseName');
        try {
          const result = await ApiClient.get({ action: 'getCourses' });
          if (result.success && result.courses) {
            select.innerHTML = '<option value="">Select a course...</option>';
            result.courses.forEach(course => {
              const option = document.createElement('option');
              option.value = course.courseName;
              option.textContent = course.courseName;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Error loading courses:', error);
        }
      }

      function closeOutingModal() {
        document.getElementById('outingModal').style.display = 'none';
        editingItem = null;
      }

      async function editOuting(date, courseName) {
        if (!societyValid) return;
        const outing = outings.find(o => {
          const oDate = o.date instanceof Date ? o.date.toISOString().split('T')[0] : String(o.date || '').trim();
          return oDate === date && o.courseName === courseName;
        });
        if (!outing) return;
        
        editingItem = outing;
        document.getElementById('outingModalTitle').textContent = 'Edit Outing';
        
        // Convert date to string format for input field
        let dateValue = outing.date;
        if (dateValue instanceof Date) {
          dateValue = dateValue.toISOString().split('T')[0];
        } else {
          dateValue = String(dateValue || '').trim();
        }
        document.getElementById('outingDate').value = dateValue;
        
        // Convert time to string format for input field
        let timeValue = outing.time;
        if (timeValue instanceof Date) {
          timeValue = `${timeValue.getHours().toString().padStart(2, '0')}:${timeValue.getMinutes().toString().padStart(2, '0')}`;
        } else {
          timeValue = String(timeValue || '').trim();
        }
        document.getElementById('outingTime').value = timeValue;
        
        document.getElementById('outingNotes').value = outing.notes || '';
        document.getElementById('outingDeleteBtnWrap').style.display = 'inline-block';
        document.getElementById('outingSaveBtn').disabled = false;
        document.getElementById('outingSaveBtn').textContent = 'Save Outing';
        
        // Populate course dropdown and set selected value
        await populateCourseDropdown();
        document.getElementById('outingCourseName').value = outing.courseName || '';
        
        document.getElementById('outingModal').style.display = 'block';
      }

      function deleteOutingFromModal() {
        if (!societyValid) return;
        let date = editingItem ? editingItem.date : document.getElementById('outingDate').value;
        const courseName = editingItem ? editingItem.courseName : document.getElementById('outingCourseName').value.trim();
        
        // Convert date to string if it's a Date object
        if (date instanceof Date) {
          date = date.toISOString().split('T')[0];
        } else {
          date = String(date || '').trim();
        }
        
        if (!date || !courseName) return;
        closeOutingModal();
        deleteOuting(date, courseName);
      }

      async function saveOuting(event) {
        event.preventDefault();
        if (!societyValid) return;
        
        // Check if adding (not editing) and would exceed max outings
        if (!editingItem) {
          if (maxCourses > 0 && outings.length >= maxCourses) {
            showAlert('error', 'There are already the maximum number of outings set up for this society (' + maxCourses + ').');
            return;
          }
        }
        
        const saveBtn = document.getElementById('outingSaveBtn');
        const originalText = saveBtn.textContent;
        
        // Show "Working..." indicator
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        const data = {
          date: document.getElementById('outingDate').value,
          time: document.getElementById('outingTime').value,
          courseName: document.getElementById('outingCourseName').value.trim(),
          notes: document.getElementById('outingNotes').value.trim()
        };

        try {
          const result = await ApiClient.post('saveOuting', data);

          if (result.success) {
            showAlert('success', 'Outing saved successfully');
            closeOutingModal();
            loadOutings();
          } else {
            showAlert('error', 'Failed to save outing: ' + (result.error || 'Unknown error'));
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
          }
        } catch (error) {
          console.error('Error saving outing:', error);
          showAlert('error', 'Error saving outing: ' + error.message);
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        }
      }

      async function deleteOuting(date, courseName) {
        if (!societyValid) return;
        if (!confirm(`Delete outing on ${date} at ${courseName}?`)) return;

        try {
          const result = await ApiClient.post('deleteOuting', {
            date: date,
            courseName: courseName
          });

          if (result.success) {
            showAlert('success', 'Outing deleted successfully');
            loadOutings();
          } else {
            showAlert('error', 'Failed to delete outing: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error deleting outing:', error);
          showAlert('error', 'Error deleting outing: ' + error.message);
        }
      }

      // Utility functions
      function showAlert(type, message) {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        container.innerHTML = '';
        container.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function escapeJsString(text) {
        if (text == null) return '';
        return String(text)
          .replace(/\\/g, '\\\\')
          .replace(/'/g, "\\'")
          .replace(/\r/g, '')
          .replace(/\n/g, '\\n');
      }

      // Close modals when clicking outside
      window.onclick = function(event) {
        ['playerModal', 'outingModal'].forEach(modalId => {
          const modal = document.getElementById(modalId);
          if (event.target === modal) {
            if (modalId === 'playerModal') closePlayerModal();
            else if (modalId === 'outingModal') closeOutingModal();
          }
        });
      }
    </script>
  </body>
</html>
